sp {sorting*propose*create-topstate-history
   (state <s> ^name sort-blocks
              ^top-state <ts>)
   (<ts> -^block-history)
-->
   (<s> ^operator <o> + =)
   (<o> ^name create-topstate-history)
}

sp {sorting*apply*create-topstate-history
   (state <s> ^name sort-blocks
              ^top-state <ts>
              ^operator.name create-topstate-history)
-->
   (<ts> ^block-history <h>)
}

sp {sorting*propose*find-block-distance*blue
   (state <s> ^name sort-blocks
              ^top-state <ts>
              ^distances <d>)
   -{(<d> ^pair <p>)
     (<p> ^block <id>
          ^location <loc>)}
   (<ts> ^world.objects <objs>
         ^block-history <h>)
   (<objs> ^object <ob1>
           ^object <ob2>)
   (<ob1> ^item-type object
         ^predicates <preds>
         ^handle <id>)
   (<preds> ^category block
            ^color blue1)
   (<ob2> ^item-type object
         ^predicates <preds2>
         ^handle <loc>)
   (<preds2> ^category location
            ^color green1)   
-->
   (<s> ^operator <o> + =)
   (<o> ^name distance-command
        ^object-a <id>
        ^object-b <loc>
        ^distance-type distance)
}

sp {sorting*propose*find-block-distance*red
   (state <s> ^name sort-blocks
              ^top-state <ts>
              ^distances <d>)
   -{(<d> ^pair <p>)
     (<p> ^block <id>
          ^location <loc>)}
   (<ts> ^world.objects <objs>
         ^block-history <h>)
   (<objs> ^object <ob1>
           ^object <ob2>)
   (<ob1> ^item-type object
         ^predicates <preds>
         ^handle <id>)
   (<preds> ^category block
            ^color red1)
   (<ob2> ^item-type object
         ^predicates <preds2>
         ^handle <loc>)
   (<preds2> ^category location
            ^color yellow1)
-->
   (<s> ^operator <o> + =)
   (<o> ^name distance-command
        ^object-a <id>
        ^object-b <loc>
        ^distance-type distance)
}

sp {sorting*propose*copy-distance
   (state <s> ^name sort-blocks
              ^distances <d>
              ^distance-command.result <r>)
-->
   (<s> ^operator <o> + =)
   (<o> ^name copy-distance)
}

sp {sorting*apply*copy-distance
   (state <s> ^name sort-blocks
              ^operator.name copy-distance
              ^distances <d>
              ^distance-command <dc>
              ^distance-filter <f>)
   (<dc> ^result <r>)
   (<f> ^a.id <oba>
        ^b.id <obb>)
-->
   (<d> ^pair <p>)
   (<p> ^block <oba>
        ^location <obb>)
   (<s> ^distance-command <dc> -
        ^distance-filter <f> -)
}

sp {sorting*propose*move-block*blue
   (state <s> ^name sort-blocks
              ^top-state <ts>)
   (<ts> ^world.objects <objs>
         ^block-history <h>)
   (<objs> ^object <ob1>
           ^object <ob2>)
   (<ob1> ^item-type object
         ^predicates <preds>
         ^handle <id>)
   (<preds> ^category block
            ^color blue1)
   (<ob2> ^item-type object
         ^predicates <preds2>
         ^handle <loc>)
   (<preds2> ^category location
            ^color green1)
-->
   (<s> ^operator <o> + =)
   (<o> ^name move-block
        ^block <ob1>
        ^location <ob2>)
   (interrupt)
}

sp {sorting*propose*move-block*red
   (state <s> ^name sort-blocks
              ^top-state <ts>)
   (<ts> ^world.objects <objs>
         ^block-history <h>)
   (<objs> ^object <ob1>
           ^object <ob2>)
   (<ob1> ^item-type object
         ^predicates <preds>
         ^handle <id>)
   (<preds> ^category block
            ^color red1)
   (<ob2> ^item-type object
         ^predicates <preds2>
         ^handle <loc>)
   (<preds2> ^category location
            ^color yellow1)
-->
   (<s> ^operator <o> + =)
   (<o> ^name move-block
        ^block <ob1>
        ^location <ob2>)
}

sp {sorting*reject*move-block*already-on-location
	(state <s> ^name sort-blocks
               ^operator <o> +
               ^top-state <ts>)
 	(<o> ^name move-block
         ^block <b>
         ^location <loc>)
    (<ts> ^world.predicates <preds>)
    (<preds> ^predicate <p>)
    (<p> ^handle on1
         ^instance <i>)
    (<i> ^1 <b>
         ^2 <loc>)
-->
	(<s> ^operator <o> -)
}

sp {sorting*reject*move-block*location-not-clear
	(state <s> ^name sort-blocks
               ^not-clear <h>
               ^operator <o> +
               ^top-state <ts>)
 	(<o> ^name move-block
         ^block <b>
         ^location <loc>)
    (<loc> ^handle <h>)
-->
	(<s> ^operator <o> -)
}

sp {sorting*reject*move-block*already-on-location*same-color
	(state <s> ^name sort-blocks
               ^operator <o> +
               ^top-state <ts>)
 	(<o> ^name move-block
         ^block <b>
         ^location <loc>)
    (<ts> ^world.predicates <preds>)
    (<preds> ^predicate <p>)
    (<p> ^handle on1
         ^instance <i>)
    (<i> ^1 <b>
         ^2 <loc2>)
    (<loc2> ^predicates <preds2>)
    (<preds2> ^category location
             ^color <c>)
    (<loc> ^predicates <preds3>)
    (<preds3> ^category location
             ^color <c>)
-->
	(<s> ^operator <o> -)
}